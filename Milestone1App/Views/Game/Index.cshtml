@model Milestone1App.Models.GameState
@{
    ViewData["Title"] = "Minesweeper";
    Layout = "_Layout";
}

<div class="container mt-4 text-center">
    <h2 class="text-primary mb-3">💣 Minesweeper</h2>

    <h2 class="mt-4 mb-3">The date and time is @DateTime.Now</h2>

    <!-- GAME SETTINGS -->
    <div class="card shadow-sm mb-3" style="max-width: 500px; margin: auto;">
        <div class="card-body">
            <h5 class="card-title">Game Settings</h5>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Rows</label>
                    <input id="rows" type="number" min="5" max="30" value="9" class="form-control text-center" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Columns</label>
                    <input id="cols" type="number" min="5" max="30" value="9" class="form-control text-center" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Difficulty</label>
                <select id="difficulty" class="form-select text-center">
                    <option value="0">Easy (10%)</option>
                    <option value="1">Normal (15%)</option>
                    <option value="2">Hard (20%)</option>
                </select>
            </div>

            <button class="btn btn-success w-100" onclick="startGame()">Start Game</button>
        </div>
    </div>

    <!-- SAVE + LOAD BUTTONS (hidden until game starts) -->
    <div id="saveLoadButtons" class="mt-3 mb-3 text-center" style="display:none;">
        <button class="btn btn-warning btn-lg" onclick="saveGame()">
            💾 Save Game
        </button>

        <a href="/SavedGames" class="btn btn-primary btn-lg" style="margin-left:10px;">
            📂 Load Saved Game
        </a>
    </div>

    <div id="status" class="fw-bold mb-3"></div>
    <div id="board" class="d-inline-block"></div>

    <div id="scoreboard" class="card shadow-sm mt-4" style="max-width: 400px; margin: auto; display:none;">
        <div class="card-body">
            <h5 class="card-title">🏆 Game Score</h5>
            <p><strong>Board Size:</strong> <span id="boardSize">0x0</span></p>
            <p><strong>Difficulty:</strong> <span id="difficultyLevel">-</span></p>
            <p><strong>Time Elapsed:</strong> <span id="elapsed">0s</span></p>
            <p><strong>Final Score:</strong> <span id="finalScore">0</span></p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let game = null;

        async function startGame() {
            const settings = {
                rows: parseInt(document.getElementById("rows").value),
                cols: parseInt(document.getElementById("cols").value),
                difficulty: parseInt(document.getElementById("difficulty").value)
            };

            const res = await fetch('/Game/Start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            game = await res.json();

            document.getElementById("saveLoadButtons").style.display = "block";
            renderBoard();
        }

        async function saveGame() {
            const res = await fetch('/Game/SaveGame', {
                method: 'POST'
            });

            if (res.ok) {
                alert("Game was successfully saved!");
            } else {
                alert("Failed to save the game.");
            }
        }

        async function reveal(r, c) {
            if (!game || game.isOver) return;
            const res = await fetch(`/Game/Reveal?row=${r}&col=${c}`, { method: 'POST' });
            game = await res.json();
            renderBoard();
        }

        async function toggleFlag(r, c) {
            const res = await fetch(`/Game/ToggleFlag?row=${r}&col=${c}`, { method: 'POST' });
            game = await res.json();
            renderBoard();
        }

        function renderBoard() {
            document.getElementById("saveLoadButtons").style.display = "block";

            let html = `<table class="mx-auto" oncontextmenu="return false;">`;
            for (let r = 0; r < game.rows; r++) {
                html += `<tr>`;
                for (let c = 0; c < game.cols; c++) {
                    const cell = game.board[r][c];
                    let content = "";
                    let cellClass = "";

                    if (cell.isRevealed) {
                        if (cell.isMine) {
                            cellClass = "mine";
                            content = "💣";
                        } else {
                            cellClass = "revealed";
                            content = cell.neighborNumber > 0 ? cell.neighborNumber : "";
                        }
                    } else if (cell.isFlagged) {
                        cellClass = "flagged";
                        content = "🚩";
                    } else {
                        cellClass = "hidden";
                    }

                    html += `<td class="${cellClass}"
                                  onclick="reveal(${r},${c})"
                                  oncontextmenu="toggleFlag(${r},${c})">${content}</td>`;
                }
                html += `</tr>`;
            }
            html += `</table>`;

            document.getElementById("board").innerHTML = html;

            const status = document.getElementById("status");

            if (game.isOver) {
                if (game.isWin) {
                    status.innerText = "🎉 You Win!";
                    status.className = "fw-bold mb-3 text-success";
                } else {
                    status.innerText = "💣 Game Over!";
                    status.className = "fw-bold mb-3 text-danger";
                }
            } else {
                status.innerText = "";
            }

            const sc = document.getElementById("scoreboard");
            if (game.isWin) {
                sc.style.display = "block";
                document.getElementById("boardSize").innerText = `${game.rows}x${game.cols}`;
                document.getElementById("difficultyLevel").innerText = ["Easy", "Normal", "Hard"][game.difficulty];
                document.getElementById("elapsed").innerText = `${Math.round(game.elapsedSeconds || 0)}s`;
                document.getElementById("finalScore").innerText = Math.round(game.score || 0);
            } else {
                sc.style.display = "none";
            }
        }
    </script>

    <style>
        #board table {
            border-collapse: collapse;
            border: 2px solid #000;
            margin-top: 10px;
        }

        #board td {
            width: 35px;
            height: 35px;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            font-size: 1.2em;
            border: 1.5px solid #555;
            user-select: none;
        }

            #board td.hidden {
                background-color: #007bff;
                color: white;
                cursor: pointer;
            }

            #board td.revealed {
                background-color: #e0e0e0;
                color: black;
            }

            #board td.mine {
                background-color: #f44336;
                color: white;
            }

            #board td.flagged {
                background-color: #007bff;
                color: yellow;
            }
    </style>
}
