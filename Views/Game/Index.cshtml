@model Milestone1App.Models.GameState
@{
    ViewData["Title"] = "Minesweeper";
    Layout = "_Layout";
}

<div class="container mt-4 text-center">
    <h2 class="text-primary mb-3">💣 Minesweeper</h2>

    <!-- TIMESTAMP (auto-updated with AJAX) -->
    <h2 id="timestamp" class="mt-4 mb-3">
        The date and time is @DateTime.Now
    </h2>

    <!-- 🎛️ Game Configuration -->
    <div class="card shadow-sm mb-3" style="max-width: 500px; margin: auto;">
        <div class="card-body">
            <h5 class="card-title">Game Settings</h5>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Rows</label>
                    <input id="rows" type="number" min="5" max="30" value="9" class="form-control text-center" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Columns</label>
                    <input id="cols" type="number" min="5" max="30" value="9" class="form-control text-center" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Difficulty</label>
                <select id="difficulty" class="form-select text-center">
                    <option value="0">Easy (10% mines)</option>
                    <option value="1">Normal (15% mines)</option>
                    <option value="2">Hard (20% mines)</option>
                </select>
            </div>

            <button class="btn btn-success w-100" onclick="startGame()">Start Game</button>
        </div>
    </div>

    <div id="status" class="fw-bold mb-3"></div>

    <!-- Board container rendered by Razor -->
    <div id="boardContainer" class="d-inline-block">
        @if (Model != null)
        {
            <input type="hidden" id="game-id" value="@Model.Id" />

            <table id="board" class="mx-auto game-grid" oncontextmenu="return false;">
                @for (int r = 0; r < Model.Rows; r++)
                {
                    <tr>
                        @for (int c = 0; c < Model.Cols; c++)
                        {
                            @await Html.PartialAsync("_CellPartial", Model.Board[r][c])
                        }
                    </tr>
                }
            </table>
        }
    </div>

    <div id="scoreboard" class="card shadow-sm mt-4" style="max-width: 400px; margin: auto; display:none;">
        <div class="card-body">
            <h5 class="card-title">🏆 Game Score</h5>
            <p><strong>Board Size:</strong> <span id="boardSize">0x0</span></p>
            <p><strong>Difficulty:</strong> <span id="difficultyLevel">-</span></p>
            <p><strong>Time Elapsed:</strong> <span id="elapsed">0s</span></p>
            <p><strong>Final Score:</strong> <span id="finalScore">0</span></p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // -------------------------------------------------------
        // TIMESTAMP UPDATE
        // -------------------------------------------------------
        function updateTimestamp() {
            const now = new Date();
            document.getElementById("timestamp").innerText =
                "The date and time is " + now.toLocaleString();
        }

        // -------------------------------------------------------
        // START GAME
        // -------------------------------------------------------
        async function startGame() {
            const settings = {
                rows: parseInt(document.getElementById("rows").value),
                cols: parseInt(document.getElementById("cols").value),
                difficulty: parseInt(document.getElementById("difficulty").value)
            };

            const res = await fetch('/Game/Start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            // Reload so Razor builds the board
            window.location.href = '/Game/Index';
        }

        // -------------------------------------------------------
        // AJAX REVEAL CELL
        // -------------------------------------------------------
        function clickCell(r, c) {
            $.post("/Game/RevealCell", { row: r, col: c }, function (partialHtml) {
                $("#cell-" + r + "-" + c).replaceWith(partialHtml);
                updateTimestamp(); // after mine click
            });
        }

        // -------------------------------------------------------
        // AJAX FLAG CELL
        // -------------------------------------------------------
        function rightClickCell(r, c) {
            $.post("/Game/FlagCell", { row: r, col: c }, function (partialHtml) {
                $("#cell-" + r + "-" + c).replaceWith(partialHtml);
                updateTimestamp(); // after right-click flag
            });
        }
    </script>

    <style>
        #board td {
            width: 35px;
            height: 35px;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            font-size: 1.2em;
            border: 1.5px solid #555;
            user-select: none;
        }

            #board td.hidden {
                background-color: #007bff;
                color: white;
                cursor: pointer;
            }

                #board td.hidden:hover {
                    background-color: #3399ff;
                }

            #board td.revealed {
                background-color: #e0e0e0;
                color: black;
            }

            #board td.mine {
                background-color: #f44336;
                color: white;
            }

            #board td.flagged {
                background-color: #007bff;
                color: yellow;
            }

            #board td.revealed:contains('1') {
                color: blue;
            }

            #board td.revealed:contains('2') {
                color: green;
            }

            #board td.revealed:contains('3') {
                color: red;
            }

            #board td.revealed:contains('4') {
                color: darkblue;
            }

            #board td.revealed:contains('5') {
                color: darkred;
            }

            #board td.revealed:contains('6') {
                color: teal;
            }

            #board td.revealed:contains('7') {
                color: black;
            }

            #board td.revealed:contains('8') {
                color: gray;
            }
    </style>
}
